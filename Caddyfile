# Merged Caddyfile for PM-App Production
# Supports both tasken.uz (domain) and direct IP access (198.163.207.39)

{
    email admin@tasken.uz
    auto_https on
    servers {
        trusted_proxies static 172.20.0.0/16
    }
}

# Domain configuration (primary)
tasken.uz {
    tls admin@tasken.uz

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' ws: wss:; frame-ancestors 'none';"
        -Server
    }

    encode gzip

    # Static assets caching
    @static path /_next/static/* /images/* /favicon.ico /robots.txt /sitemap.xml
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Health check
    @health path /api/health
    respond @health "OK" 200

    # WebSocket support (Socket.IO)
    @websocket {
        header Connection *Upgrade*
        header Upgrade websocket
        path /api/socketio*
    }

    reverse_proxy pm-app:3000 {
        health_uri /api/health
        health_interval 30s
        health_timeout 10s
        lb_policy round_robin
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            read_timeout 300s
            write_timeout 300s
            dial_timeout 30s
        }
    }

    log {
        output file /var/log/caddy/access.log {
            roll_size 100MB
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }

    handle_errors {
        @5xx expression {http.error.status_code} >= 500
        @4xx expression {http.error.status_code} >= 400 && {http.error.status_code} < 500
        respond @5xx "Internal Server Error" 500
        respond @4xx "Not Found" 404
    }
}

# Direct IP access - use proxy, no automatic Let's Encrypt for IP
198.163.207.39 {
    # Don't attempt ACME for IP; use TLS with internal (or skip TLS if using external proxy)
    tls internal

    header {
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    @health path /api/health
    respond @health "OK" 200

    reverse_proxy pm-app:3000 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    log {
        output file /var/log/caddy/ip-access.log {
            roll_size 50MB
            roll_keep 3
            roll_keep_for 720h
        }
        format json
        level INFO
    }
}

# HTTP redirect to HTTPS for both domain and IP
http://tasken.uz {
    redir https://{host}{uri} permanent
}

http://198.163.207.39 {
    redir https://198.163.207.39{uri} permanent
}
